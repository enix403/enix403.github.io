<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"> -->
    <link rel="icon" href="https://fav.farm/%F0%9F%8C%B3" />
    
		<link href="../../_app/immutable/assets/0.Lr-ipS2R.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/PostWrapper.DBt_Rvdl.css" rel="stylesheet">
		<link rel="modulepreload" href="../../_app/immutable/entry/start.ByQXOcAH.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/entry.DSHG_-6M.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/runtime.DAdlOyt1.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index.BFqC5wTN.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index-client.CLFkXoHg.js">
		<link rel="modulepreload" href="../../_app/immutable/entry/app.BGJ4YPWq.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/preload-helper.C1FmrZbK.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/render.BPDshUiE.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/template.DVMwHGRA.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/disclose-version.Bg9kRutz.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/svelte-component.T3r7NlUW.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/props.BgTLVgWm.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/0.CklukcQG.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/legacy.CtaTdtmd.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/attributes.BfS5JpBa.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/lifecycle.CNc0vRWN.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/4.BdUT7l7B.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/format.BzRktsyD.js"><!--[--><!--]--><title>Implementing And Understanding NeRF</title>
  </head>
  <body>
    <!--[--><!--[--><!----><main class="min-h-screen bg-[--app-bg-color]"><div class="bg-[#262A2B] px-6 py-8 md:px-8"><a href="/"><h1 class="text-2xl leading-9 sm:text-3xl md:text-4xl xl:text-[2.5rem]">Welcome to my place,</h1></a> <p class="text-sm text-[#B2ACA2] md:mt-2 md:text-lg">Qateef Ahmad's Blogs</p></div> <div class="mx-auto flex max-w-[1280px] items-stretch max-xl:flex-col xl:mb-20"><div class="max-w-full flex-1 px-6 pt-10 pb-12 md:px-8"><div class="w-full max-w-full"><!----><div class="post-wrapper svelte-1w8k1rr"><header class="prose-sm border-b border-app-line pb-3 md:prose-base"><h1 class="!my-0 font-semibold">Implementing And Understanding NeRF</h1> <p class="!mb-0 !mt-1 text-sm font-thin italic text-slate-500">Posted by Qateef Ahmad on July 21, 2024</p></header> <div class="post-body"><!----><h3><strong>Introduction</strong></h3> <p>Neural Radiance Fields (NeRF), introduced in the paper <a href="https://arxiv.org/abs/2003.08934" rel="nofollow">“NeRF: Representing Scenes as Neural Radiance Fields for View Synthesis”</a> by Mildenhall et al., offers a groundbreaking approach for representing volumetric fields and 3D scenes. By leveraging the power of deep neural networks and differentiable volume rendering, NeRF can synthesize photo-realistic views of complex scenes from a sparse set of input images.</p> <p>Unlike traditional methods, NeRF encodes scene geometry and appearance into a continuous 5D function parameterized by a neural network. This function takes as input a 3D spatial point and a viewing direction and outputs color (<span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>G</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">RGB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">RGB</span></span></span></span><!----></span>) and volume density values. This formulation allows NeRF to model intricate lighting effects, occlusions, and detailed textures.</p> <h3><strong>What Are Neural Radiance Fields?</strong></h3> <p>At its core, a Neural Radiance Field (NeRF) is a neural network that models the radiance emitted by a scene at every point in 3D space, along every possible viewing direction. Formally, it can be described as a function:</p> <div class="math math-display"><!----><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>F</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo separator="true">,</mo><mi mathvariant="bold">d</mi><mo stretchy="false">)</mo><mo>→</mo><mo stretchy="false">(</mo><mi mathvariant="bold">c</mi><mo separator="true">,</mo><mi>σ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">F_\theta(\mathbf{x}, \mathbf{d}) \to (\mathbf{c}, \sigma)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathbf">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose">)</span></span></span></span></span><!----></div> <p>where:</p> <ul><li><span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (x, y, z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span><!----></span> is the 3D spatial coordinate of the point.</li> <li><span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">d</mi><mo>=</mo><mo stretchy="false">(</mo><mi>θ</mi><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{d} = (\theta, \phi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathbf">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span></span><!----></span> represents the viewing direction, parameterized in spherical coordinates.</li> <li><span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">c</mi><mo>=</mo><mo stretchy="false">(</mo><mi>r</mi><mo separator="true">,</mo><mi>g</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{c} = (r, g, b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord mathbf">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span><!----></span> is the RGB color at the given point.</li> <li><span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span><!----></span> is the volume density (a measure of opacity or likelihood of light being scattered or absorbed).</li> <li><span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">F_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><!----></span> is the neural network, parameterized by <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><!----></span>, which is optimized during training.</li></ul> <p>Ray are marched through the scene (starting from the camera), and this neural network is evaluated on multiple <em>query points</em> alongs these rays. Finally the color and density information at these query points for each ray are combined into a single color which is the final output color of the ray. Colors from all such rays are used to make up the final 2D rendered image.</p> <h2><strong>Implementing NeRF</strong></h2> <p>Below is a step by step implementation of NeRF, in Python and PyTorch. Throughout the code, assume the following imports are available throughout.</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#C792EA;font-style:italic">import</span><span style="color:#D6DEEB"> torch</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">from</span><span style="color:#D6DEEB"> torch </span><span style="color:#C792EA;font-style:italic">import</span><span style="color:#D6DEEB"> nn</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">import</span><span style="color:#D6DEEB"> torch.nn.functional </span><span style="color:#C792EA;font-style:italic">as</span><span style="color:#D6DEEB"> F</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">import</span><span style="color:#D6DEEB"> matplotlib.pyplot </span><span style="color:#C792EA;font-style:italic">as</span><span style="color:#D6DEEB"> plt</span></span></code></pre><!----> <h4>Let’s start</h4> <p>Given a camera pose (position and viewing direction), the first thing we do is march a bundle of rays from the camera through every pixel of the image plane. The image plane is a plane placed in front of the camera where the final render of the 3D scene will be drawn. Think of it as a canvas where the final rendered scene will be drawn.</p> <p>Before moving on, let’s clear up what a <em>camera pose</em> even is. A camera pose is a <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">4 \times 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span><!----></span> transformation matrix defining a transformation from camera-space to world-space.</p> <div class="math math-display"><!----><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Pose</mtext><mo>=</mo><msub><mi>T</mi><mtext>cam-to-world</mtext></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>R</mi><mn>00</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>R</mi><mn>01</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>R</mi><mn>02</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>T</mi><mi>x</mi></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>R</mi><mn>10</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>R</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>R</mi><mn>12</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>T</mi><mi>y</mi></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>R</mi><mn>20</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>R</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>R</mi><mn>22</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>T</mi><mi>z</mi></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Pose} = T_{\text{cam-to-world}} = \begin{bmatrix}
R_{00} &amp; R_{01} &amp; R_{02} &amp; T_x \\
R_{10} &amp; R_{11} &amp; R_{12} &amp; T_y \\
R_{20} &amp; R_{21} &amp; R_{22} &amp; T_z \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">Pose</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">cam-to-world</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">00</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">01</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">02</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"></span><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span></span></span></span></span></span><!----></div> <p>where the top <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span><!----></span> sub-matix represents the rotation of the camera, while the last column contains the translation <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>T</mi><mi>x</mi></msub><mo separator="true">,</mo><msub><mi>T</mi><mi>y</mi></msub><mo separator="true">,</mo><msub><mi>T</mi><mi>z</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[T_x, T_y, T_z]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span><!----></span> of the camera.</p> <p>The first step will be to create a bundle of rays (origins and directions) passing through each pixel of the image.</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> nf_get_ray_bundle</span><span style="color:#D9F5DD">(</span></span>
<span class="line"><span style="color:#7FDBCA">    height</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#7FDBCA">    width</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#7FDBCA">    focal_length</span><span style="color:#D6DEEB">: torch.Tensor,</span></span>
<span class="line"><span style="color:#7FDBCA">    pose</span><span style="color:#D6DEEB">: torch.Tensor</span></span>
<span class="line"><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D6DEEB">    points_x, points_y </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">meshgrid</span><span style="color:#D6DEEB">(</span></span>
<span class="line"><span style="color:#82AAFF">        torch.</span><span style="color:#B2CCD6">arange</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">width</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        torch.</span><span style="color:#B2CCD6">arange</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">height</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D7DBE0">        indexing</span><span style="color:#C792EA">=</span><span style="color:#D9F5DD">'</span><span style="color:#ECC48D">xy</span><span style="color:#D9F5DD">'</span></span>
<span class="line"><span style="color:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    points_x </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> (points_x </span><span style="color:#C792EA">-</span><span style="color:#D6DEEB"> width </span><span style="color:#C792EA">/</span><span style="color:#F78C6C"> 2.0</span><span style="color:#D6DEEB">) </span><span style="color:#C792EA">/</span><span style="color:#D6DEEB"> focal_length</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # Note the -ve here, y in grid increases downwards while</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # y in NDC increases upwards</span></span>
<span class="line"><span style="color:#D6DEEB">    points_y </span><span style="color:#C792EA">=</span><span style="color:#C792EA"> -</span><span style="color:#D6DEEB">(points_y </span><span style="color:#C792EA">-</span><span style="color:#D6DEEB"> height </span><span style="color:#C792EA">/</span><span style="color:#F78C6C"> 2.0</span><span style="color:#D6DEEB">) </span><span style="color:#C792EA">/</span><span style="color:#D6DEEB"> focal_length</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # Camera faces the -ve Z direction in NDC</span></span>
<span class="line"><span style="color:#D6DEEB">    points_z </span><span style="color:#C792EA">=</span><span style="color:#C792EA"> -</span><span style="color:#D6DEEB">torch.</span><span style="color:#B2CCD6">ones_like</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">points_x</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    ray_dirs </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">stack</span><span style="color:#D6DEEB">(</span></span>
<span class="line"><span style="color:#82AAFF">        (</span></span>
<span class="line"><span style="color:#82AAFF">            points_x,</span></span>
<span class="line"><span style="color:#82AAFF">            points_y,</span></span>
<span class="line"><span style="color:#82AAFF">            points_z,</span></span>
<span class="line"><span style="color:#82AAFF">        )</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D7DBE0">        dim</span><span style="color:#C792EA">=-</span><span style="color:#F78C6C">1</span></span>
<span class="line"><span style="color:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    transform_rot </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> pose[:</span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">, :</span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">]</span></span>
<span class="line"><span style="color:#D6DEEB">    ray_dirs </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> ray_dirs </span><span style="color:#C792EA">@</span><span style="color:#D6DEEB"> transform_rot.T</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    ray_origins </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> pose[:</span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">, </span><span style="color:#C792EA">-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">].</span><span style="color:#B2CCD6">expand</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">ray_dirs.shape</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    return</span><span style="color:#D6DEEB"> ray_origins, ray_dirs</span></span>
<span class="line"></span></code></pre><!----> <p>Now we have a set of <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo>×</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">H \times W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span><!----></span> rays passing through each pixel. The next step is to create a set of query points along each rays. The following function does just that.</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> nf_create_query_points</span><span style="color:#D9F5DD">(</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, 3)</span></span>
<span class="line"><span style="color:#7FDBCA">    ray_origins</span><span style="color:#D6DEEB">: torch.Tensor,</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, 3)</span></span>
<span class="line"><span style="color:#7FDBCA">    ray_dirs</span><span style="color:#D6DEEB">: torch.Tensor,</span></span>
<span class="line"><span style="color:#7FDBCA">    thresh_near</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">float</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#7FDBCA">    thresh_far</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">float</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#7FDBCA">    num_samples_per_ray</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (N,)</span></span>
<span class="line"><span style="color:#D6DEEB">    depths </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">linspace</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">thresh_near</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> thresh_far</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> num_samples_per_ray</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, N, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">    query_points </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> (</span></span>
<span class="line"><span style="color:#D6DEEB">        ray_origins[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, </span><span style="color:#FF5874">None</span><span style="color:#D6DEEB">, :]</span></span>
<span class="line"><span style="color:#C792EA">        +</span><span style="color:#D6DEEB"> ray_dirs[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, </span><span style="color:#FF5874">None</span><span style="color:#D6DEEB">, :] </span><span style="color:#C792EA">*</span><span style="color:#D6DEEB"> depths[:, </span><span style="color:#FF5874">None</span><span style="color:#D6DEEB">]</span></span>
<span class="line"><span style="color:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    #      (H, W, N, 3)  (*, N)</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    return</span><span style="color:#D6DEEB"> query_points, depths</span></span></code></pre><!----> <p>Recall that the neural network’s output should be 4 values representing the color <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>R</mi><mo separator="true">,</mo><mi>G</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(R, G, B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span><!----></span> and the volume density <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span><!----></span> at the given query point. We will create the model later on, but for now assume that the <code>model</code> variable is, well, the NeRF model. It will take the query point as well as it’s viewing direction (which is just the position of the camera) concatenated together into a 6-tuple (3 for position and 3 for viewing direction). We can then evaluate this model on the query points created and returned by this function above as follows.</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> nf_render_pose</span><span style="color:#D9F5DD">(</span></span>
<span class="line"><span style="color:#7FDBCA">    height</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#7FDBCA">    width</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # This will input tensor of shape (*, 6) and output</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # tensor of shape (*, 4)</span></span>
<span class="line"><span style="color:#7FDBCA">    model</span><span style="color:#D6DEEB">: torch.nn.Module,</span></span>
<span class="line"><span style="color:#7FDBCA">    focal_length</span><span style="color:#D6DEEB">: torch.Tensor,</span></span>
<span class="line"><span style="color:#7FDBCA">    pose</span><span style="color:#D6DEEB">: torch.Tensor,</span></span>
<span class="line"><span style="color:#7FDBCA">    thresh_near</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#7FDBCA">    thresh_far</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#7FDBCA">    num_samples_per_ray</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # Create rays</span></span>
<span class="line"><span style="color:#D6DEEB">    ray_origins, ray_dirs </span><span style="color:#C792EA">=</span><span style="color:#B2CCD6"> nf_get_ray_bundle</span><span style="color:#D6DEEB">(</span></span>
<span class="line"><span style="color:#82AAFF">        height</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        width</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        focal_length</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        pose</span></span>
<span class="line"><span style="color:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # Create query points</span></span>
<span class="line"><span style="color:#D6DEEB">    query_points, depths </span><span style="color:#C792EA">=</span><span style="color:#B2CCD6"> nf_create_query_points</span><span style="color:#D6DEEB">(</span></span>
<span class="line"><span style="color:#82AAFF">        ray_origins</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        ray_dirs</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        thresh_near</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        thresh_far</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        num_samples_per_ray</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H*W*N, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">    flat_query_points </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> query_points.</span><span style="color:#B2CCD6">view</span><span style="color:#D6DEEB">(</span><span style="color:#C792EA">-</span><span style="color:#F78C6C">1</span><span style="color:#D9F5DD">,</span><span style="color:#F78C6C"> 3</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, N, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">    viewdirs_origin </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> ray_dirs </span><span style="color:#C792EA">/</span><span style="color:#D6DEEB"> torch.linalg.</span><span style="color:#B2CCD6">norm</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">ray_dirs</span><span style="color:#D9F5DD">,</span><span style="color:#D7DBE0"> dim</span><span style="color:#C792EA">=-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, </span><span style="color:#FF5874">None</span><span style="color:#D9F5DD">]</span></span>
<span class="line"><span style="color:#D6DEEB">    viewdirs </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> viewdirs_origin[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, </span><span style="color:#FF5874">None</span><span style="color:#D6DEEB">, :].</span><span style="color:#B2CCD6">expand</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">query_points.shape</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H*W*N, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">    flat_viewdirs </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> viewdirs.</span><span style="color:#B2CCD6">reshape</span><span style="color:#D6DEEB">(</span><span style="color:#C792EA">-</span><span style="color:#F78C6C">1</span><span style="color:#D9F5DD">,</span><span style="color:#F78C6C"> 3</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H*W*N, 6)</span></span>
<span class="line"><span style="color:#D6DEEB">    flat_inputs </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">cat</span><span style="color:#D6DEEB">(</span><span style="color:#D9F5DD">[</span><span style="color:#82AAFF">flat_query_points, flat_viewdirs</span><span style="color:#D9F5DD">],</span><span style="color:#D7DBE0"> dim</span><span style="color:#C792EA">=-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H*W*N, 4)</span></span>
<span class="line"><span style="color:#D6DEEB">    flat_view_field </span><span style="color:#C792EA">=</span><span style="color:#B2CCD6"> model</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">chunk</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, N, 4)</span></span>
<span class="line"><span style="color:#D6DEEB">    view_field </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> flat_view_field.</span><span style="color:#B2CCD6">view</span><span style="color:#D6DEEB">(</span><span style="color:#C5E478">list</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">query_points.shape</span><span style="color:#D6DEEB">[</span><span style="color:#82AAFF">:</span><span style="color:#C792EA">-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">])</span><span style="color:#C792EA"> +</span><span style="color:#D9F5DD"> [</span><span style="color:#C792EA">-</span><span style="color:#F78C6C">1</span><span style="color:#D9F5DD">]</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # ....</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (This function nf_render_view_field() will be implemented later)</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, 3)</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    return</span><span style="color:#B2CCD6"> nf_render_view_field</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">view_field</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> depths</span><span style="color:#D6DEEB">)</span></span></code></pre><!----> <p>All this (<small><em>convoluted</em></small>) piece of code does is create and evaluate the query points (along each ray) on the model to get their color and volume density values stored in the <code>view_field</code> variable.</p> <h4>Combining the Query Points</h4> <p>The paper presents the following equation to get the final accumulated color of a ray <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">r</mi></mrow><annotation encoding="application/x-tex">\mathbf{r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord mathbf">r</span></span></span></span><!----></span>.</p> <div class="math math-display"><!----><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>C</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">r</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mtext>exp</mtext><mo stretchy="false">(</mo><mo>−</mo><msub><mi>σ</mi><mi>i</mi></msub><msub><mi>δ</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><msub><mi mathvariant="bold">c</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{C}(\mathbf{r}) = \sum_{i=1}^{n}T_i(1 - \text{exp}(-\sigma_i\delta_i))\mathbf{c}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">C</span></span><span class="mopen">(</span><span class="mord mathbf">r</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">exp</span></span><span class="mopen">(</span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span><span class="mord"><span class="mord mathbf">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><!----></div> <p>where</p> <div class="math math-display"><!----><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub><mo>=</mo><mtext>exp</mtext><mo stretchy="false">(</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mi>i</mi></mrow><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></munderover><msub><mi>σ</mi><mi>j</mi></msub><msub><mi>δ</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">T_{i} = \text{exp}(-\sum_{j=i}^{i-1}\sigma_j\delta_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.2254em;vertical-align:-1.4138em;"></span><span class="mord text"><span class="mord">exp</span></span><span class="mopen">(</span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8117em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span><!----></div> <p>and <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>δ</mi><mi>i</mi></msub><mo>=</mo><msub><mi>t</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\delta_i = t_{i+1} - t_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8234em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><!----></span> is the distance between consective query points <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">t_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><!----></span>. This function reduces to traditional alpha compositing with alpha values <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo>−</mo><mtext>exp</mtext><mo stretchy="false">(</mo><mo>−</mo><msub><mi>σ</mi><mi>i</mi></msub><msub><mi>δ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\alpha_i = 1 - \text{exp}(-\sigma_i\delta_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">exp</span></span><span class="mopen">(</span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0379em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><!----></span>.</p> <p>We will implement this rendering in the following <code>nf_render_view_field()</code> function.</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> cumprod_exclusive</span><span style="color:#D9F5DD">(</span><span style="color:#7FDBCA">tensor</span><span style="color:#D6DEEB">: torch.Tensor</span><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB"> -> torch.Tensor:</span></span>
<span class="line"><span style="color:#D6DEEB">    cumprod </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">cumprod</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">tensor</span><span style="color:#D9F5DD">,</span><span style="color:#D7DBE0"> dim</span><span style="color:#C792EA">=-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D6DEEB">    cumprod </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">roll</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">cumprod</span><span style="color:#D9F5DD">,</span><span style="color:#F78C6C"> 1</span><span style="color:#D9F5DD">,</span><span style="color:#D7DBE0"> dims</span><span style="color:#C792EA">=-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D6DEEB">    cumprod[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, </span><span style="color:#F78C6C">0</span><span style="color:#D6DEEB">] </span><span style="color:#C792EA">=</span><span style="color:#F78C6C"> 1</span><span style="color:#D6DEEB">.</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    return</span><span style="color:#D6DEEB"> cumprod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> nf_render_view_field</span><span style="color:#D9F5DD">(</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, N, 4)</span></span>
<span class="line"><span style="color:#7FDBCA">    view_field</span><span style="color:#D6DEEB">: torch.Tensor,</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (N,) or (H, W, N)</span></span>
<span class="line"><span style="color:#7FDBCA">    depths</span><span style="color:#D6DEEB">: torch.Tensor,</span></span>
<span class="line"><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, N, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">    rgb_field </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> view_field[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, :</span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">]</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, N)</span></span>
<span class="line"><span style="color:#D6DEEB">    sigma_field </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> view_field[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, </span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # Sigmoid function is used as rgb color must be in the range [0, 1]</span></span>
<span class="line"><span style="color:#D6DEEB">    rgb_field </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> F.</span><span style="color:#B2CCD6">sigmoid</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">rgb_field</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # Similarly relu is used here as density is always positive</span></span>
<span class="line"><span style="color:#D6DEEB">    sigma_field </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> F.</span><span style="color:#B2CCD6">relu</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">sigma_field</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (*, N - 1)</span></span>
<span class="line"><span style="color:#D6DEEB">    deltas </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> depths[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, </span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">:] </span><span style="color:#C792EA">-</span><span style="color:#D6DEEB"> depths[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, :</span><span style="color:#C792EA">-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (*, N)</span></span>
<span class="line"><span style="color:#D6DEEB">    deltas </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">cat</span><span style="color:#D6DEEB">(</span></span>
<span class="line"><span style="color:#82AAFF">        (</span></span>
<span class="line"><span style="color:#637777;font-style:italic">            # (*, N - 1)</span></span>
<span class="line"><span style="color:#82AAFF">            deltas,</span></span>
<span class="line"><span style="color:#637777;font-style:italic">            # (*, 1)</span></span>
<span class="line"><span style="color:#82AAFF">            torch.</span><span style="color:#B2CCD6">tensor</span><span style="color:#D6DEEB">(</span><span style="color:#D9F5DD">[</span><span style="color:#F78C6C">1e10</span><span style="color:#D9F5DD">]</span><span style="color:#D6DEEB">)</span><span style="color:#82AAFF">.</span><span style="color:#B2CCD6">expand</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">deltas</span><span style="color:#D6DEEB">[</span><span style="color:#82AAFF">..., :</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">]</span><span style="color:#82AAFF">.shape</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#82AAFF">        )</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D7DBE0">        dim</span><span style="color:#C792EA">=-</span><span style="color:#F78C6C">1</span></span>
<span class="line"><span style="color:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, N)</span></span>
<span class="line"><span style="color:#D6DEEB">    alpha </span><span style="color:#C792EA">=</span><span style="color:#F78C6C"> 1</span><span style="color:#D6DEEB">. </span><span style="color:#C792EA">-</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">exp</span><span style="color:#D6DEEB">(</span><span style="color:#C792EA">-</span><span style="color:#82AAFF">sigma_field </span><span style="color:#C792EA">*</span><span style="color:#82AAFF"> deltas</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, N)</span></span>
<span class="line"><span style="color:#D6DEEB">    weights </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> alpha </span><span style="color:#C792EA">*</span><span style="color:#B2CCD6"> cumprod_exclusive</span><span style="color:#D6DEEB">(</span><span style="color:#F78C6C">1</span><span style="color:#82AAFF">. </span><span style="color:#C792EA">-</span><span style="color:#82AAFF"> alpha </span><span style="color:#C792EA">+</span><span style="color:#F78C6C"> 1e-10</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, N, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">    rgb_map_points </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> (</span></span>
<span class="line"><span style="color:#637777;font-style:italic">      # (H, W, N, 1)</span></span>
<span class="line"><span style="color:#D6DEEB">      weights[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, </span><span style="color:#FF5874">None</span><span style="color:#D6DEEB">]</span></span>
<span class="line"><span style="color:#C792EA">      *</span></span>
<span class="line"><span style="color:#637777;font-style:italic">      # (H, W, N, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">      rgb_field</span></span>
<span class="line"><span style="color:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (H, W, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">    c_r </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> rgb_map_points.</span><span style="color:#B2CCD6">sum</span><span style="color:#D6DEEB">(</span><span style="color:#D7DBE0">dim</span><span style="color:#C792EA">=-</span><span style="color:#F78C6C">2</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    return</span><span style="color:#D6DEEB"> c_r</span></span></code></pre><!----> <p>That the bulk of rendering part done. Now we will move to designing the actual neural network.</p> <h3>Creating the Neural Network</h3> <p>The network will be simple MLP with position and view direction input and will output 4 values representing the <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>R</mi><mo separator="true">,</mo><mi>G</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(R, G, B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span><!----></span> color and the volume density <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span><!----></span> at the given position.</p> <h4>Positional Encoding</h4> <p>We can directly feed the query points and viewing directions into the neural network. However, as the paper suggest, it is beneficial to map the query points to a high-dimensional space before evaluation. NeRF employs <strong>positional encoding</strong> of the input coordinates <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord mathbf">x</span></span></span></span><!----></span> and <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">d</mi></mrow><annotation encoding="application/x-tex">\mathbf{d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathbf">d</span></span></span></span><!----></span>. Raw inputs are transformed into higher-dimensional representations using sinusoidal functions.</p> <p>The encoding maps a 3D coordinate into a <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>+</mo><mn>6</mn><mi>L</mi></mrow><annotation encoding="application/x-tex">3 + 6L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">6</span><span class="mord mathnormal">L</span></span></span></span><!----></span>-D coordinate, where <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span><!----></span> is a configurable hyperparameter.</p> <div class="math math-display"><!----><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>γ</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">(</mo><mi>sin</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mn>2</mn><mn>0</mn></msup><mi>π</mi><mi>p</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mn>2</mn><mn>0</mn></msup><mi>π</mi><mi>p</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>sin</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mn>2</mn><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup><mi>π</mi><mi>p</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mn>2</mn><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup><mi>π</mi><mi>p</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\gamma(p) = \left(\sin(2^0 \pi p), \cos(2^0 \pi p), \ldots, \sin(2^{L-1} \pi p), \cos(2^{L-1} \pi p)\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2413em;vertical-align:-0.35em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span></span><!----></div> <p>This function <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\gamma(p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span><!----></span> is applied separately to each of the three coordinate values.</p> <p>Here is the code for that</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> positional_encoding</span><span style="color:#D9F5DD">(</span></span>
<span class="line"><span style="color:#7FDBCA">    points</span><span style="color:#D6DEEB">: torch.Tensor,</span></span>
<span class="line"><span style="color:#7FDBCA">    L</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#C792EA">=</span><span style="color:#F78C6C">6</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D6DEEB">    encoding </span><span style="color:#C792EA">=</span><span style="color:#D9F5DD"> [</span><span style="color:#D6DEEB">points</span><span style="color:#D9F5DD">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    freqs </span><span style="color:#C792EA">=</span><span style="color:#F78C6C"> 2.0</span><span style="color:#C792EA"> **</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">linspace</span><span style="color:#D6DEEB">(</span><span style="color:#F78C6C">0.0</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> L </span><span style="color:#C792EA">-</span><span style="color:#F78C6C"> 1</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> L</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    for</span><span style="color:#D6DEEB"> freq </span><span style="color:#C792EA;font-style:italic">in</span><span style="color:#D6DEEB"> freqs:</span></span>
<span class="line"><span style="color:#D6DEEB">        encoding.</span><span style="color:#B2CCD6">append</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">torch.</span><span style="color:#B2CCD6">sin</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">points </span><span style="color:#C792EA">*</span><span style="color:#82AAFF"> freq</span><span style="color:#D6DEEB">))</span></span>
<span class="line"><span style="color:#D6DEEB">        encoding.</span><span style="color:#B2CCD6">append</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">torch.</span><span style="color:#B2CCD6">cos</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">points </span><span style="color:#C792EA">*</span><span style="color:#82AAFF"> freq</span><span style="color:#D6DEEB">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    if</span><span style="color:#C5E478"> len</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">encoding</span><span style="color:#D6DEEB">) </span><span style="color:#C792EA">==</span><span style="color:#F78C6C"> 1</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">        return</span><span style="color:#D6DEEB"> encoding[</span><span style="color:#F78C6C">0</span><span style="color:#D6DEEB">]</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    else</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">        return</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">cat</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">encoding</span><span style="color:#D9F5DD">,</span><span style="color:#D7DBE0"> dim</span><span style="color:#C792EA">=-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">)</span></span></code></pre><!----> <p>This encoding allows the neural network to capture fine details and complex variations in lighting and geometry, as highlighted in the NeRF paper.</p> <p>Also, we will need a few more helper functions for the working of the network.</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#D6DEEB">embed_num_pos </span><span style="color:#C792EA">=</span><span style="color:#F78C6C"> 6</span></span>
<span class="line"><span style="color:#D6DEEB">embed_num_dir </span><span style="color:#C792EA">=</span><span style="color:#F78C6C"> 6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> split_queries</span><span style="color:#D9F5DD">(</span></span>
<span class="line"><span style="color:#7FDBCA">    self</span><span style="color:#D6DEEB">,</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (B, 6)</span></span>
<span class="line"><span style="color:#7FDBCA">    queries</span><span style="color:#D6DEEB">: torch.Tensor</span></span>
<span class="line"><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (B, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">    points </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> queries[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, :</span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">]</span></span>
<span class="line"><span style="color:#637777;font-style:italic">    # (B, 3)</span></span>
<span class="line"><span style="color:#D6DEEB">    viewdirs </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> queries[</span><span style="color:#82AAFF">...</span><span style="color:#D6DEEB">, </span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">:]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    x_pos </span><span style="color:#C792EA">=</span><span style="color:#B2CCD6"> positional_encoding</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">points</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> embed_num_pos</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D6DEEB">    x_dir </span><span style="color:#C792EA">=</span><span style="color:#B2CCD6"> positional_encoding</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">viewdirs</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> embed_num_dir</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    return</span><span style="color:#D6DEEB"> x_pos, x_dir</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> embed_len_3d</span><span style="color:#D9F5DD">(</span><span style="color:#7FDBCA">L</span><span style="color:#D6DEEB">: </span><span style="color:#C5E478">int</span><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    return</span><span style="color:#F78C6C"> 3</span><span style="color:#C792EA"> +</span><span style="color:#F78C6C"> 6</span><span style="color:#C792EA"> *</span><span style="color:#D6DEEB"> L</span></span></code></pre><!----> <p>And finally, here is a simple network.</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#C792EA">class</span><span style="color:#FFCB8B"> SimpleNeRF</span><span style="color:#D6DEEB">(</span><span style="color:#C5E478">nn</span><span style="color:#D6DEEB">.</span><span style="color:#C5E478">Module</span><span style="color:#D6DEEB">):</span></span>
<span class="line"><span style="color:#C792EA">    def</span><span style="color:#C5E478"> __init__</span><span style="color:#D9F5DD">(</span><span style="color:#7FDBCA">self</span><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#C5E478">        super</span><span style="color:#D6DEEB">().</span><span style="color:#C5E478">__init__</span><span style="color:#D6DEEB">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">        hidden_size </span><span style="color:#C792EA">=</span><span style="color:#F78C6C"> 128</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8EACE3">        self</span><span style="color:#D6DEEB">.layers </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> nn.</span><span style="color:#B2CCD6">Sequential</span><span style="color:#D6DEEB">(</span></span>
<span class="line"><span style="color:#637777;font-style:italic">            # Layer 1: input (both pos and view dir)</span></span>
<span class="line"><span style="color:#82AAFF">            nn.</span><span style="color:#B2CCD6">Linear</span><span style="color:#D6DEEB">(</span></span>
<span class="line"><span style="color:#B2CCD6">                embed_len_3d</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">embed_num_pos</span><span style="color:#D6DEEB">)</span><span style="color:#C792EA"> +</span><span style="color:#B2CCD6"> embed_len_3d</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">embed_num_dir</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">                hidden_size</span></span>
<span class="line"><span style="color:#D6DEEB">            )</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">            nn.</span><span style="color:#B2CCD6">ReLU</span><span style="color:#D6DEEB">()</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#637777;font-style:italic">            # Hidden layers</span></span>
<span class="line"><span style="color:#82AAFF">            torch.nn.</span><span style="color:#B2CCD6">Linear</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">hidden_size</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> hidden_size</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> nn.</span><span style="color:#B2CCD6">ReLU</span><span style="color:#D6DEEB">()</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">            torch.nn.</span><span style="color:#B2CCD6">Linear</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">hidden_size</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> hidden_size</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> nn.</span><span style="color:#B2CCD6">ReLU</span><span style="color:#D6DEEB">()</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#637777;font-style:italic">            # Output layer (colors + density)</span></span>
<span class="line"><span style="color:#82AAFF">            torch.nn.</span><span style="color:#B2CCD6">Linear</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">hidden_size</span><span style="color:#D9F5DD">,</span><span style="color:#F78C6C"> 4</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D6DEEB">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    def</span><span style="color:#82AAFF;font-style:italic"> forward</span><span style="color:#D9F5DD">(</span><span style="color:#7FDBCA">self</span><span style="color:#D6DEEB">, </span><span style="color:#7FDBCA">queries</span><span style="color:#D6DEEB">: torch.Tensor</span><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#D6DEEB">        x_pos, x_dir </span><span style="color:#C792EA">=</span><span style="color:#B2CCD6"> split_queries</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">queries</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D6DEEB">        x </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">cat</span><span style="color:#D6DEEB">(</span><span style="color:#D9F5DD">[</span><span style="color:#82AAFF">x_pos, x_dir</span><span style="color:#D9F5DD">],</span><span style="color:#D7DBE0"> dim</span><span style="color:#C792EA">=-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">        return</span><span style="color:#8EACE3"> self</span><span style="color:#D6DEEB">.</span><span style="color:#B2CCD6">layers</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">x</span><span style="color:#D6DEEB">)</span></span></code></pre><!----> <h3>Training the Neural Network</h3> <p>The neural network is optimized to minimize the MSE loss between the rendered pixel values and the ground truth from input images:</p> <h4>Loss Calculation</h4> <p>The loss function used in the paper is a simple mean squared error loss between the predicted color and the true color of each pixel of the image.</p> <div class="math math-display"><!----><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">L</mi><mo>=</mo><munder><mo>∑</mo><mrow><mi mathvariant="bold">r</mi><mo>∈</mo><mi mathvariant="script">R</mi></mrow></munder><msubsup><mrow><mo fence="true">∥</mo><mi mathvariant="bold">C</mi><mo stretchy="false">(</mo><mi mathvariant="bold">r</mi><mo stretchy="false">)</mo><mo>−</mo><msup><mi mathvariant="bold">C</mi><mtext>GT</mtext></msup><mo stretchy="false">(</mo><mi mathvariant="bold">r</mi><mo stretchy="false">)</mo><mo fence="true">∥</mo></mrow><mn>2</mn><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\mathcal{L} = \sum_{\mathbf{r} \in \mathcal{R}} \left\| \mathbf{C}(\mathbf{r}) - \mathbf{C}^\text{GT}(\mathbf{r}) \right\|_2^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.417em;vertical-align:-1.3217em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8557em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">r</span><span class="mrel mtight">∈</span><span class="mord mathcal mtight">R</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3217em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"></span><span style="width:0.556em;height:1.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.556em" height="1.200em" viewBox="0 0 556 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z
M367 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M410 15 H367 v585 v0 v585 h43z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span><span class="mord mathbf">C</span><span class="mopen">(</span><span class="mord mathbf">r</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathbf">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord text mtight"><span class="mord mtight">GT</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">r</span><span class="mclose">)</span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"></span><span style="width:0.556em;height:1.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.556em" height="1.200em" viewBox="0 0 556 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z
M367 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M410 15 H367 v585 v0 v585 h43z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0953em;"><span style="top:-2.3003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.3442em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3997em;"><span></span></span></span></span></span></span></span></span></span></span><!----></div> <p>Here, <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">R</mi></mrow><annotation encoding="application/x-tex">\mathcal{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">R</span></span></span></span><!----></span> is the set of rays corresponding to the input images, and <span class="math math-inline"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">C</mi><mtext>GT</mtext></msup><mo stretchy="false">(</mo><mi mathvariant="bold">r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{C}^\text{GT}(\mathbf{r})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathbf">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord text mtight"><span class="mord mtight">GT</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">r</span><span class="mclose">)</span></span></span></span><!----></span> represents the true pixel color for each ray.</p> <h4>Training Loop</h4> <p>We can use a standard pytorch training flow for training the network. I will not get into the details of the loading the training data, but on a high level, each training example is a pose along with it’s ground truth rendered image.</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#637777;font-style:italic"># Assume this is a list of (pose, image) tuples</span></span>
<span class="line"><span style="color:#D6DEEB">train_dataset </span><span style="color:#C792EA">=</span><span style="color:#82AAFF"> ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic"># Also assume that variables (like height and width, etc) are</span></span>
<span class="line"><span style="color:#637777;font-style:italic"># set appropriately</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> predict</span><span style="color:#D9F5DD">(</span><span style="color:#7FDBCA">pose</span><span style="color:#D6DEEB">: torch.Tensor</span><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    return</span><span style="color:#B2CCD6"> nf_render_pose</span><span style="color:#D6DEEB">(</span></span>
<span class="line"><span style="color:#82AAFF">        height</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        width</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        model</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#82AAFF">        focal_length</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D7DBE0">        pose</span><span style="color:#C792EA">=</span><span style="color:#82AAFF">pose</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D7DBE0">        thresh_near</span><span style="color:#C792EA">=</span><span style="color:#F78C6C">2</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D7DBE0">        thresh_far</span><span style="color:#C792EA">=</span><span style="color:#F78C6C">6</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D7DBE0">        num_samples_per_ray</span><span style="color:#C792EA">=</span><span style="color:#F78C6C">32</span><span style="color:#D9F5DD">,</span></span>
<span class="line"><span style="color:#D6DEEB">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic"># Create the model</span></span>
<span class="line"><span style="color:#D6DEEB">model </span><span style="color:#C792EA">=</span><span style="color:#B2CCD6"> SimpleNeRF</span><span style="color:#D6DEEB">()</span></span>
<span class="line"><span style="color:#D6DEEB">optimizer </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.optim.</span><span style="color:#B2CCD6">Adam</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">model.</span><span style="color:#B2CCD6">parameters</span><span style="color:#D6DEEB">()</span><span style="color:#D9F5DD">,</span><span style="color:#D7DBE0"> lr</span><span style="color:#C792EA">=</span><span style="color:#F78C6C">0.01</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">num_epochs </span><span style="color:#C792EA">=</span><span style="color:#F78C6C"> 16</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">for</span><span style="color:#D6DEEB"> i </span><span style="color:#C792EA;font-style:italic">in</span><span style="color:#C5E478"> range</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">num_epochs</span><span style="color:#D6DEEB">):</span></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    for</span><span style="color:#D6DEEB"> target_pose, target_image </span><span style="color:#C792EA;font-style:italic">in</span><span style="color:#D6DEEB"> train_dataset:</span></span>
<span class="line"><span style="color:#D6DEEB">        optimizer.</span><span style="color:#B2CCD6">zero_grad</span><span style="color:#D6DEEB">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">        image_predicted </span><span style="color:#C792EA">=</span><span style="color:#B2CCD6"> predict</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">target_pose</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D6DEEB">        loss </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> F.</span><span style="color:#B2CCD6">mse_loss</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">image_predicted</span><span style="color:#D9F5DD">,</span><span style="color:#82AAFF"> target_image</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">        loss.</span><span style="color:#B2CCD6">backward</span><span style="color:#D6DEEB">()</span></span>
<span class="line"><span style="color:#D6DEEB">        optimizer.</span><span style="color:#B2CCD6">step</span><span style="color:#D6DEEB">()</span></span></code></pre><!----> <p>Once the training is complete, the network can be used to view the scene from any arbitrary position and viewing angle! You can do something like this</p> <!----><pre class="shiki night-owl" style="background-color:#011627;color:#d6deeb" tabindex="0"><code><span class="line"><span style="color:#637777;font-style:italic"># Generates a random pose on a sphere of given radius</span></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF;font-style:italic"> random_spherical_pose</span><span style="color:#D9F5DD">(</span><span style="color:#7FDBCA">radius=</span><span style="color:#F78C6C">4</span><span style="color:#D9F5DD">)</span><span style="color:#D6DEEB">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    theta </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> (torch.</span><span style="color:#B2CCD6">rand</span><span style="color:#D6DEEB">(</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">) </span><span style="color:#C792EA">*</span><span style="color:#D6DEEB"> torch.pi </span><span style="color:#C792EA">*</span><span style="color:#F78C6C"> 2</span><span style="color:#D6DEEB">).</span><span style="color:#B2CCD6">item</span><span style="color:#D6DEEB">()</span></span>
<span class="line"><span style="color:#D6DEEB">    phi </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> (torch.</span><span style="color:#B2CCD6">rand</span><span style="color:#D6DEEB">(</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">) </span><span style="color:#C792EA">*</span><span style="color:#D6DEEB"> torch.pi </span><span style="color:#C792EA">*</span><span style="color:#F78C6C"> 2</span><span style="color:#D6DEEB">).</span><span style="color:#B2CCD6">item</span><span style="color:#D6DEEB">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    R_x </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">tensor</span><span style="color:#D6DEEB">(</span><span style="color:#D9F5DD">[[</span><span style="color:#F78C6C">1</span><span style="color:#82AAFF">, </span><span style="color:#F78C6C">0</span><span style="color:#82AAFF">, </span><span style="color:#F78C6C">0</span><span style="color:#D9F5DD">]</span><span style="color:#82AAFF">,</span></span>
<span class="line"><span style="color:#D9F5DD">                        [</span><span style="color:#F78C6C">0</span><span style="color:#82AAFF">, torch.</span><span style="color:#B2CCD6">cos</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">theta</span><span style="color:#D6DEEB">)</span><span style="color:#82AAFF">, </span><span style="color:#C792EA">-</span><span style="color:#82AAFF">torch.</span><span style="color:#B2CCD6">sin</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">theta</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">]</span><span style="color:#82AAFF">,</span></span>
<span class="line"><span style="color:#D9F5DD">                        [</span><span style="color:#F78C6C">0</span><span style="color:#82AAFF">, torch.</span><span style="color:#B2CCD6">sin</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">theta</span><span style="color:#D6DEEB">)</span><span style="color:#82AAFF">, torch.</span><span style="color:#B2CCD6">cos</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">theta</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">]]</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    R_y </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">tensor</span><span style="color:#D6DEEB">(</span><span style="color:#D9F5DD">[[</span><span style="color:#82AAFF">torch.</span><span style="color:#B2CCD6">cos</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">phi</span><span style="color:#D6DEEB">)</span><span style="color:#82AAFF">, </span><span style="color:#F78C6C">0</span><span style="color:#82AAFF">, torch.</span><span style="color:#B2CCD6">sin</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">phi</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">]</span><span style="color:#82AAFF">,</span></span>
<span class="line"><span style="color:#D9F5DD">                        [</span><span style="color:#F78C6C">0</span><span style="color:#82AAFF">, </span><span style="color:#F78C6C">1</span><span style="color:#82AAFF">, </span><span style="color:#F78C6C">0</span><span style="color:#D9F5DD">]</span><span style="color:#82AAFF">,</span></span>
<span class="line"><span style="color:#D9F5DD">                        [</span><span style="color:#C792EA">-</span><span style="color:#82AAFF">torch.</span><span style="color:#B2CCD6">sin</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">phi</span><span style="color:#D6DEEB">)</span><span style="color:#82AAFF">, </span><span style="color:#F78C6C">0</span><span style="color:#82AAFF">, torch.</span><span style="color:#B2CCD6">cos</span><span style="color:#D6DEEB">(</span><span style="color:#82AAFF">phi</span><span style="color:#D6DEEB">)</span><span style="color:#D9F5DD">]]</span><span style="color:#D6DEEB">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    cam_rot </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> R_y </span><span style="color:#C792EA">@</span><span style="color:#D6DEEB"> R_x</span></span>
<span class="line"></span>
<span class="line"><span style="color:#637777;font-style:italic">    # Make the camera look towards the origin</span></span>
<span class="line"><span style="color:#D6DEEB">    cam_backwards </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> cam_rot[:, </span><span style="color:#C792EA">-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">]</span></span>
<span class="line"><span style="color:#D6DEEB">    cam_pos </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> radius </span><span style="color:#C792EA">*</span><span style="color:#D6DEEB"> cam_backwards</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">    pose </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> torch.</span><span style="color:#B2CCD6">eye</span><span style="color:#D6DEEB">(</span><span style="color:#F78C6C">4</span><span style="color:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D6DEEB">    pose[:</span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">, :</span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">] </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> cam_rot</span></span>
<span class="line"><span style="color:#D6DEEB">    pose[:</span><span style="color:#F78C6C">3</span><span style="color:#D6DEEB">, </span><span style="color:#C792EA">-</span><span style="color:#F78C6C">1</span><span style="color:#D6DEEB">] </span><span style="color:#C792EA">=</span><span style="color:#D6DEEB"> cam_pos</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;font-style:italic">    return</span><span style="color:#D6DEEB"> pose</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D6DEEB">plt.</span><span style="color:#B2CCD6">imshow</span><span style="color:#D6DEEB">(</span><span style="color:#B2CCD6">predict</span><span style="color:#D6DEEB">(</span><span style="color:#B2CCD6">random_spherical_pose</span><span style="color:#D6DEEB">())</span><span style="color:#82AAFF">.</span><span style="color:#B2CCD6">detach</span><span style="color:#D6DEEB">())</span></span></code></pre><!----> <h3>Conclusion</h3> <p>Neural Radiance Fields (NeRF) does offer unprecedented quality and flexibility for reconstructing scenes from sparse image data. However, its computational demands and static scene assumption are some areas for improvement. Training a NeRF model is computationally intensive and often requirs hours or even days on powerful GPUs.</p> <p>There are some interesting ideas that I haven’t touched in this post, such as hierarchical sampling which optimizes NeRF’s efficiency, and converting the learned scene volume representation into 3D point cloud meshes — all of this perhaps for another post.</p> <p>One thing to note is that the standard NeRF formulation assumes that the scene is static, making it unsuitable for dynamic environments where objects or lighting conditions change over time. Extensions like <em>Dynamic NeRF</em> attempt to address this, but these approaches add complexity and often require significantly more data.</p> <p>At the end, I recommend reading the original paper <a href="https://arxiv.org/abs/2003.08934" rel="nofollow">“NeRF: Representing Scenes as Neural Radiance Fields for View Synthesis”</a> by Mildenhall et al.</p><!----></div></div><!----><!----></div></div> <div class="xl:w-56 shrink-0 bg-[#191917] px-4 py-4 text-[0.813rem]"><h2 class="border-b border-app-line text-lg">About Me</h2> <p class="mt-1">Hi, I am a self-taught programmer that likes technology, programming, mathematics, and
        artificial intelligence. Beyond coding, I enjoy writing articles here.</p> <p class="mt-4">I also like 3D modelling, though I have just started and I am total beginner in it.</p> <div class="mt-2 flex gap-2"><a href="https://github.com/enix403"><span style="display: inline-block; position: relative; overflow: hidden; width: 48px; height: 48px;" class="social-icon"><div class="social-container" style="position: absolute; inset: 0; width: 100%; height: 100%;"><svg class="social-svg" viewBox="0 0 64 64" style="border-radius: 50%; position: absolute; inset: 0; width: 100%; height: 100%; fill-rule: evenodd;"><g class="social-svg-background" style="@media (prefers-reduced-motion: no-preference) { --ms-transition: 'fill 170ms ease-in-out'; -o-transition: 'fill 170ms ease-in-out'; --moz-transition: 'fill 170ms ease-in-out'; --webkit-transition: 'fill 170ms ease-in-out'; transition: 'fill 170ms ease-in-out';} fill: transparent;"><circle cx="32" cy="32" r="31"></circle></g><g class="social-svg-icon" fill="white"><path d="M32,16c-8.8,0-16,7.2-16,16c0,7.1,4.6,13.1,10.9,15.2 c0.8,0.1,1.1-0.3,1.1-0.8c0-0.4,0-1.4,0-2.7c-4.5,1-5.4-2.1-5.4-2.1c-0.7-1.8-1.8-2.3-1.8-2.3c-1.5-1,0.1-1,0.1-1 c1.6,0.1,2.5,1.6,2.5,1.6c1.4,2.4,3.7,1.7,4.7,1.3c0.1-1,0.6-1.7,1-2.1c-3.6-0.4-7.3-1.8-7.3-7.9c0-1.7,0.6-3.2,1.6-4.3 c-0.2-0.4-0.7-2,0.2-4.2c0,0,1.3-0.4,4.4,1.6c1.3-0.4,2.6-0.5,4-0.5c1.4,0,2.7,0.2,4,0.5c3.1-2.1,4.4-1.6,4.4-1.6 c0.9,2.2,0.3,3.8,0.2,4.2c1,1.1,1.6,2.5,1.6,4.3c0,6.1-3.7,7.5-7.3,7.9c0.6,0.5,1.1,1.5,1.1,3c0,2.1,0,3.9,0,4.4 c0,0.4,0.3,0.9,1.1,0.8C43.4,45.1,48,39.1,48,32C48,23.2,40.8,16,32,16z"></path></g><g class="social-svg-mask" fill="black" style="@media (prefers-reduced-motion: no-preference) { --ms-transition: 'fill 170ms ease-in-out'; -o-transition: 'fill 170ms ease-in-out'; --moz-transition: 'fill 170ms ease-in-out'; --webkit-transition: 'fill 170ms ease-in-out'; transition: 'fill 170ms ease-in-out';}"><path d="M0,0v64h64V0H0z M37.1,47.2c-0.8,0.2-1.1-0.3-1.1-0.8c0-0.5,0-2.3,0-4.4c0-1.5-0.5-2.5-1.1-3 c3.6-0.4,7.3-1.7,7.3-7.9c0-1.7-0.6-3.2-1.6-4.3c0.2-0.4,0.7-2-0.2-4.2c0,0-1.3-0.4-4.4,1.6c-1.3-0.4-2.6-0.5-4-0.5 c-1.4,0-2.7,0.2-4,0.5c-3.1-2.1-4.4-1.6-4.4-1.6c-0.9,2.2-0.3,3.8-0.2,4.2c-1,1.1-1.6,2.5-1.6,4.3c0,6.1,3.7,7.5,7.3,7.9 c-0.5,0.4-0.9,1.1-1,2.1c-0.9,0.4-3.2,1.1-4.7-1.3c0,0-0.8-1.5-2.5-1.6c0,0-1.6,0-0.1,1c0,0,1,0.5,1.8,2.3c0,0,0.9,3.1,5.4,2.1 c0,1.3,0,2.3,0,2.7c0,0.4-0.3,0.9-1.1,0.8C20.6,45.1,16,39.1,16,32c0-8.8,7.2-16,16-16c8.8,0,16,7.2,16,16 C48,39.1,43.4,45.1,37.1,47.2z"></path></g></svg></div></span><!----></a> <a href="https://www.linkedin.com/in/qateefahmad003/"><span style="display: inline-block; position: relative; overflow: hidden; width: 48px; height: 48px;" class="social-icon"><div class="social-container" style="position: absolute; inset: 0; width: 100%; height: 100%;"><svg class="social-svg" viewBox="0 0 64 64" style="border-radius: 50%; position: absolute; inset: 0; width: 100%; height: 100%; fill-rule: evenodd;"><g class="social-svg-background" style="@media (prefers-reduced-motion: no-preference) { --ms-transition: 'fill 170ms ease-in-out'; -o-transition: 'fill 170ms ease-in-out'; --moz-transition: 'fill 170ms ease-in-out'; --webkit-transition: 'fill 170ms ease-in-out'; transition: 'fill 170ms ease-in-out';} fill: transparent;"><circle cx="32" cy="32" r="31"></circle></g><g class="social-svg-icon" fill="white"><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z"></path></g><g class="social-svg-mask" fill="#007fb1" style="@media (prefers-reduced-motion: no-preference) { --ms-transition: 'fill 170ms ease-in-out'; -o-transition: 'fill 170ms ease-in-out'; --moz-transition: 'fill 170ms ease-in-out'; --webkit-transition: 'fill 170ms ease-in-out'; transition: 'fill 170ms ease-in-out';}"><path d="M0,0v64h64V0H0z M25.8,44h-5.4V26.6h5.4V44z M23.1,24.3c-1.7,0-3.1-1.4-3.1-3.1c0-1.7,1.4-3.1,3.1-3.1 c1.7,0,3.1,1.4,3.1,3.1C26.2,22.9,24.8,24.3,23.1,24.3z M46,44h-5.4v-8.4c0-2,0-4.6-2.8-4.6c-2.8,0-3.2,2.2-3.2,4.5V44h-5.4V26.6 h5.2V29h0.1c0.7-1.4,2.5-2.8,5.1-2.8c5.5,0,6.5,3.6,6.5,8.3V44z"></path></g></svg></div></span><!----></a></div></div></div></main><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_wbxal5 = {
						base: new URL("../..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../../_app/immutable/entry/start.ByQXOcAH.js"),
						import("../../_app/immutable/entry/app.BGJ4YPWq.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 4],
							data: [null,{"type":"data","data":null,"uses":{}}],
							form: null,
							error: null
						});
					});
				}
			</script>
		
  </body>
</html>
